<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Chat</title>
<script src="lib/marked.min.js"></script>
<script src="lib/highlight.min.js"></script>
<link rel="stylesheet" href="lib/github-dark.min.css">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f14; --bg2:#13161e; --bg3:#1a1e29; --bg4:#21263a;
  --border:#252b40; --border2:#3a4570;
  --text:#e8eaf2; --text2:#9aa3c2; --text3:#5c6480;
  --accent:#5b8dee; --accent2:#4070d4; --accent-glow:rgba(91,141,238,0.15);
  --green:#4ecb8c; --red:#e05c6c; --yellow:#f5c542;
  --rail:52px; --panel:292px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 16px 0 0;height:52px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:10px;padding-left:calc(var(--rail) + 14px)}
.logo{display:flex;align-items:center;gap:7px;font-size:15px;font-weight:600;letter-spacing:-.3px}
.logo-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent)}
.model-badge{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);background:var(--bg3);border:1px solid var(--border);padding:3px 9px;border-radius:20px;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.topbar-right{display:flex;align-items:center;gap:8px}
.status-wrap{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3)}
.status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.status-dot.green{background:var(--green);box-shadow:0 0 5px var(--green)}
.status-dot.yellow{background:var(--yellow);animation:pulse 1s infinite}
.status-dot.red{background:var(--red);box-shadow:0 0 5px var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.btn{display:inline-flex;align-items:center;gap:6px;padding:6px 13px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--bg3);color:var(--text);border-color:var(--border2)}
.btn-danger{background:transparent;color:var(--red);border:1px solid rgba(224,92,108,.3)}
.btn-danger:hover{background:rgba(224,92,108,.1)}

/* MAIN */
.main{display:flex;flex:1;overflow:hidden}

/* ICON RAIL */
.rail{width:var(--rail);flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:8px 0;gap:4px;z-index:10}
.rail-btn{width:36px;height:36px;border-radius:9px;border:1px solid transparent;background:transparent;color:var(--text3);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;flex-shrink:0}
.rail-btn:hover{background:var(--bg3);color:var(--text)}
.rail-btn.active{background:var(--accent-glow);color:var(--accent);border-color:rgba(91,141,238,.25)}
.rail-btn svg{width:17px;height:17px}
.rail-sep{width:28px;height:1px;background:var(--border);margin:4px 0}

/* SLIDE PANEL */
.sidebar-panel{width:var(--panel);flex-shrink:0;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;transition:width .22s cubic-bezier(.4,0,.2,1),opacity .22s}
.sidebar-panel.hidden{width:0;opacity:0;border-right:none}
.panel-inner{width:var(--panel);flex:1;display:flex;flex-direction:column;overflow:hidden}
.panel-header{padding:14px 15px 11px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.panel-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3)}
.panel-close{width:22px;height:22px;border-radius:5px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.panel-close:hover{background:var(--bg3);color:var(--text)}
.panel-body{flex:1;overflow-y:auto;padding:13px 14px;display:flex;flex-direction:column;gap:0}
.panel-body::-webkit-scrollbar{width:3px}
.panel-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* COLLAPSIBLE */
.collapse-head{display:flex;align-items:center;justify-content:space-between;padding:8px 2px;cursor:pointer;-webkit-user-select:none;user-select:none}
.collapse-head-left{display:flex;align-items:center;gap:7px;font-size:10.5px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3)}
.collapse-head-left svg{width:13px;height:13px}
.collapse-arrow{width:13px;height:13px;color:var(--text3);transition:transform .18s;flex-shrink:0}
.collapse-arrow.open{transform:rotate(90deg)}
.collapse-body{display:flex;flex-direction:column;gap:13px;padding-bottom:12px}
.collapse-body.closed{display:none}

/* FIELDS */
.field{display:flex;flex-direction:column;gap:5px}
.field-label{font-size:11.5px;font-weight:500;color:var(--text2);display:flex;align-items:center;justify-content:space-between}
.field-hint{font-size:10.5px;color:var(--text3);font-weight:400}
.input,.textarea{background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;font-family:'DM Sans',sans-serif;transition:border-color .15s,box-shadow .15s;width:100%;outline:none}
.input{padding:7px 10px;height:33px;font-size:12px}
.input:focus,.textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
.textarea{padding:8px 10px;resize:vertical;min-height:70px;line-height:1.5;font-size:12px}
.mono-input{font-family:'JetBrains Mono',monospace;font-size:10.5px}

/* SLIDER */
.slider-row{display:flex;align-items:center;gap:8px}
.slider{-webkit-appearance:none;appearance:none;flex:1;height:3px;border-radius:2px;background:var(--bg4);outline:none;cursor:pointer}
.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);box-shadow:0 0 5px rgba(91,141,238,.4);cursor:pointer;transition:transform .1s}
.slider::-webkit-slider-thumb:hover{transform:scale(1.25)}
.slider-val{font-family:'JetBrains Mono',monospace;font-size:10.5px;color:var(--accent);min-width:40px;text-align:right}

/* TOGGLE */
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 11px}
.toggle-info{display:flex;flex-direction:column;gap:2px}
.toggle-name{font-size:12.5px;font-weight:500;color:var(--text)}
.toggle-desc{font-size:10.5px;color:var(--text3)}
.toggle{position:relative;width:34px;height:18px;background:var(--bg4);border-radius:9px;cursor:pointer;flex-shrink:0;border:1px solid var(--border);transition:background .2s}
.toggle.on{background:var(--accent);border-color:var(--accent)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:#fff;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
.toggle.on::after{transform:translateX(16px)}

.divider{height:1px;background:var(--border);margin:5px 0}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.stat-box{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:8px 10px}
.stat-label{font-size:10px;color:var(--text3);margin-bottom:3px}
.stat-val{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--accent)}

/* CONV LIST */
.new-chat-btn-inline{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:background .15s;margin-left:8px;margin-right:auto}
.new-chat-btn-inline:hover{background:var(--accent2)}
.new-chat-btn-inline svg{width:14px;height:14px}
.conv-list{flex:1;overflow-y:auto;padding:7px 9px;display:flex;flex-direction:column;gap:3px}
.conv-list::-webkit-scrollbar{width:3px}
.conv-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.conv-empty{text-align:center;color:var(--text3);font-size:12px;padding:20px 10px}
.conv-item{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:8px;cursor:pointer;border:1px solid transparent;transition:all .14s;position:relative}
.conv-item:hover{background:var(--bg3);border-color:var(--border)}
.conv-item.active{background:var(--accent-glow);border-color:rgba(91,141,238,.3)}
.conv-icon{width:27px;height:27px;border-radius:7px;background:var(--bg4);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.conv-icon svg{width:13px;height:13px;color:var(--text3)}
.conv-info{flex:1;min-width:0}
.conv-title{font-size:12.5px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.conv-meta{font-size:10.5px;color:var(--text3);margin-top:1px}
.conv-del{width:20px;height:20px;border-radius:4px;border:none;background:transparent;color:var(--text3);display:none;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:all .15s}
.conv-item:hover .conv-del{display:flex}
.conv-del:hover{background:rgba(224,92,108,.15);color:var(--red)}

/* CHAT AREA */
.chat-area{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg)}
.messages{flex:1;overflow-y:auto;padding:18px 0;scroll-behavior:smooth}
.messages::-webkit-scrollbar{width:4px}
.messages::-webkit-scrollbar-track{background:transparent}
.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* message-row: ~1 char height (≈1em) vertical spacing */
.message-row{padding:7px 64px 7px 26px;display:flex;gap:12px;max-width:860px;margin:0 auto;width:100%;animation:fadeUp .18s ease;align-items:flex-start;margin-bottom:12px}
.message-row.user-row{flex-direction:row-reverse;padding-right:26px;padding-left:calc(26px + 29px + 12px)}
.message-row.user-row .bubble{display:flex;flex-direction:column;align-items:flex-end}
.message-row.user-row .bubble-name{text-align:right}
.message-row.user-row .bubble-content.user-msg{max-width:480px}
@keyframes fadeUp{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

.avatar{width:29px;height:29px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;margin-top:-12px}
.avatar.user{background:var(--bg4);color:var(--text2);border:1px solid var(--border2)}
.avatar.assistant{background:linear-gradient(135deg,rgba(91,141,238,.13),rgba(78,203,140,.1));color:var(--accent);border:1px solid rgba(91,141,238,.22)}
.bubble{flex:1;min-width:0}
.bubble-name{font-size:11px;font-weight:600;color:var(--text3);margin-bottom:4px;letter-spacing:.3px}
.bubble-name.user-name{color:var(--text2)}
.bubble-name.ai-name{color:var(--accent)}
.bubble-content{font-size:14px;line-height:1.7;color:var(--text)}
.bubble-content.user-msg{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:9px 14px;white-space:pre-line;word-break:break-word}
.bubble-content.ai-msg{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:9px 14px;word-break:break-word}

/* Markdown */
.bubble-content h1,.bubble-content h2,.bubble-content h3{color:var(--text);font-weight:600;margin:12px 0 5px;border-bottom:1px solid var(--border);padding-bottom:4px}
.bubble-content h1{font-size:17px}.bubble-content h2{font-size:15px}.bubble-content h3{font-size:14px;border:none}
.bubble-content p{margin:5px 0}
.bubble-content ul,.bubble-content ol{margin:6px 0;padding-left:20px}
.bubble-content li{margin:3px 0}
.bubble-content code{font-family:'JetBrains Mono',monospace;font-size:12px;background:var(--bg4);border:1px solid var(--border);padding:1px 5px;border-radius:4px;color:#a8d8a8}
.bubble-content pre{margin:8px 0}
.bubble-content pre code{background:transparent;border:none;padding:0;border-radius:0;font-size:12.5px;line-height:1.6;color:inherit}
.code-block-wrap{margin:8px 0;border-radius:9px;border:1px solid var(--border);overflow:hidden}
.code-header{display:flex;align-items:center;justify-content:space-between;background:var(--bg4);padding:6px 13px;border-bottom:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text3)}
.copy-btn{cursor:pointer;padding:2px 7px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);border-radius:4px;font-size:10.5px;transition:all .15s}
.copy-btn:hover{color:var(--text);border-color:var(--border2)}
.bubble-content .hljs{padding:12px 14px}
.bubble-content blockquote{border-left:3px solid var(--accent);padding:4px 12px;color:var(--text2);background:var(--bg3);border-radius:0 6px 6px 0;margin:6px 0}
.bubble-content table{width:100%;border-collapse:collapse;margin:8px 0;font-size:13px}
.bubble-content th{background:var(--bg3);border:1px solid var(--border);padding:6px 11px;text-align:left;font-weight:600;color:var(--text2)}
.bubble-content td{border:1px solid var(--border);padding:6px 11px}
.bubble-content a{color:var(--accent);text-decoration:none}
.bubble-content a:hover{text-decoration:underline}
.bubble-content strong{color:#fff;font-weight:600}

.typing-cursor{display:inline-block;width:2px;height:14px;background:var(--accent);border-radius:1px;animation:blink .65s infinite;vertical-align:middle;margin-left:2px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--text3)}
.empty-icon{font-size:34px;opacity:.2}
.empty-title{font-size:15px;font-weight:500;color:var(--text2)}
.empty-sub{font-size:12.5px}
.error-bubble{display:flex;align-items:flex-start;gap:8px;background:rgba(224,92,108,.07);border:1px solid rgba(224,92,108,.22);border-radius:8px;padding:9px 13px;color:var(--red);font-size:13px;line-height:1.5}

/* INPUT BAR */
.input-bar-outer{background:var(--bg);border-top:1px solid var(--border);flex-shrink:0}
.input-bar{padding:12px 24px 15px;max-width:860px;margin:0 auto;width:100%}
.input-wrap{display:flex;gap:9px;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:13px;padding:9px 15px;transition:border-color .15s,box-shadow .15s}
.input-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}
#user-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;line-height:1.5;resize:none;max-height:180px;overflow-y:auto;padding:0}
#user-input::placeholder{color:var(--text3)}
#user-input::-webkit-scrollbar{width:3px}
#user-input::-webkit-scrollbar-thumb{background:var(--border2)}
.send-btn{width:36px;height:36px;border-radius:9px;background:var(--accent);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .15s,transform .1s,box-shadow .2s}
.send-btn:hover{background:var(--accent2)}
.send-btn:active{transform:scale(.93)}
.send-btn.stop-mode{background:var(--red);box-shadow:0 0 14px rgba(224,92,108,.4)}
.send-btn.stop-mode:hover{background:#c94455}
.send-btn svg{width:15px;height:15px}
.input-footer{display:flex;justify-content:space-between;align-items:center;padding:5px 4px 0;font-size:11px;color:var(--text3)}
.key-hint{display:flex;gap:5px;align-items:center}
kbd{background:var(--bg3);border:1px solid var(--border);padding:1px 5px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:10px}
.char-count{font-family:'JetBrains Mono',monospace}

.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--bg3);border:1px solid var(--border2);color:var(--text);padding:8px 16px;border-radius:8px;font-size:13px;opacity:0;transition:all .2s;z-index:999;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Accessibility */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}

/* Panel Styles */
#panel-settings, #panel-history{display:none;flex-direction:column;height:100%}
#panel-settings.active, #panel-history.active{display:flex}

/* Field Hint Success */
.field-hint.success{color:var(--green);margin-top:3px}

/* Stop Icon */
#stop-icon{display:none}
#stop-icon.visible{display:inline-block}

/* Plain Text */
.plain-text{white-space:pre-wrap}

/* Stop Marker */
.stop-marker{font-size:11px;color:var(--text3);margin-left:8px}

/* Utility Classes */
.hidden{display:none !important}

/* PRESET DROPDOWN */
.preset-selector{position:relative}
.preset-btn{display:flex;align-items:center;justify-content:space-between;width:100%;padding:7px 10px;height:33px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:border-color .15s;text-align:left}
.preset-btn:hover,.preset-btn.open{border-color:var(--accent)}
.preset-btn svg{width:12px;height:12px;color:var(--text3);transition:transform .15s;flex-shrink:0}
.preset-btn.open svg{transform:rotate(180deg)}
.preset-dropdown{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;z-index:100;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.4)}
.preset-item{display:flex;align-items:center;padding:7px 10px;cursor:pointer;gap:6px;transition:background .12s}
.preset-item:hover{background:var(--bg4)}
.preset-item.active{background:var(--accent-glow)}
.preset-item-name{flex:1;font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.preset-item-name-input{flex:1;background:var(--bg4);border:1px solid var(--accent);border-radius:4px;color:var(--text);font-size:12px;padding:1px 5px;outline:none;font-family:'DM Sans',sans-serif;min-width:0}
.preset-item-actions{display:none;gap:3px;flex-shrink:0}
.preset-item:hover .preset-item-actions{display:flex}
.preset-action-btn{width:20px;height:20px;border-radius:4px;border:none;background:transparent;color:var(--text3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s}
.preset-action-btn:hover{background:var(--bg3);color:var(--text)}
.preset-action-btn.del:hover{background:rgba(224,92,108,.15);color:var(--red)}
.preset-action-btn svg{width:11px;height:11px}
.preset-divider{height:1px;background:var(--border);margin:3px 0}
.preset-new-btn{display:flex;align-items:center;gap:6px;padding:7px 10px;cursor:pointer;color:var(--accent);font-size:12px;transition:background .12s}
.preset-new-btn:hover{background:var(--bg4)}
.preset-new-btn svg{width:13px;height:13px}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <div class="logo"><div class="logo-dot"></div>AI Chat</div>
    <div class="model-badge" id="model-badge">deepseek/deepseek-chat-v3.1</div>
  </div>
  <div class="topbar-right">
    <div class="status-wrap">
      <span class="status-dot green" id="status-dot"></span>
      <span id="status-text">就绪</span>
    </div>
    <button class="btn btn-danger" onclick="clearCurrentChat()">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      清空对话
    </button>
  </div>
</div>

<div class="main">
  <!-- Icon Rail -->
  <div class="rail">
    <button class="rail-btn active" id="rail-settings" onclick="switchPanel('settings')" title="参数配置">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </button>
    <button class="rail-btn" id="rail-history" onclick="switchPanel('history')" title="对话列表">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </button>
    <div class="rail-sep"></div>
  </div>

  <!-- Slide Panel -->
  <div class="sidebar-panel" id="sidebar-panel">
    <div class="panel-inner">

      <!-- Settings Panel -->
      <div id="panel-settings" class="active">
        <div class="panel-header">
          <span class="panel-title">参数配置</span>
          <button class="panel-close" onclick="switchPanel(null)" aria-label="关闭面板">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="panel-body">

          <!-- API -->
          <div class="collapse-head" onclick="toggleCollapse('api')">
            <div class="collapse-head-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              API 设置
            </div>
            <svg class="collapse-arrow open" id="arrow-api" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </div>
          <div class="collapse-body" id="body-api">
            <div class="field">
              <label class="field-label">API 预设</label>
              <div class="preset-selector" id="preset-selector">
                <button class="preset-btn" id="preset-btn" onclick="togglePresetDropdown()" type="button">
                  <span id="preset-btn-name">openrouter</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="preset-dropdown hidden" id="preset-dropdown"></div>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="api-url">API 端点</label>
              <input class="input mono-input" id="api-url" type="text" oninput="onPresetFieldChange()" aria-label="API 端点地址">
            </div>
            <div class="field">
              <label class="field-label" for="api-key">API Key</label>
              <input class="input mono-input" id="api-key" type="text" placeholder="输入你的 API Key" oninput="handleApiKeyInput()" aria-label="API 密钥">
            </div>
            <div class="field">
              <label class="field-label" for="model-name">模型名称</label>
              <input class="input mono-input" id="model-name" type="text" oninput="document.getElementById('model-badge').textContent=this.value;onPresetFieldChange()" aria-label="AI 模型名称">
            </div>
            <div class="field">
              <label class="field-label" for="api-format">API 格式</label>
              <select class="input" id="api-format" onchange="onPresetFieldChange()" aria-label="API 格式">
                <option value="openai">OpenAI 兼容（默认）</option>
                <option value="claude">Anthropic Claude</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Gen Params -->
          <div class="collapse-head" onclick="toggleCollapse('gen')">
            <div class="collapse-head-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="14" y2="12"/><line x1="4" y1="18" x2="17" y2="18"/></svg>
              生成参数
            </div>
            <svg class="collapse-arrow open" id="arrow-gen" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </div>
          <div class="collapse-body" id="body-gen">
            <div class="field">
              <label class="field-label" for="s-max-tokens">Max Tokens <span class="field-hint">（最大输出长度，0 = 不限）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-max-tokens" type="range" min="0" max="8192" step="128" value="0" oninput="syncParam(this,'max-tokens-val',v=>v==0?'∞':v)" aria-label="最大令牌数">
                <span class="slider-val" id="max-tokens-val">∞</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-chat-memory">Chat Memory <span class="field-hint">（上下文轮数，0 = 不限）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-chat-memory" type="range" min="0" max="50" step="1" value="10" oninput="syncParam(this,'chat-memory-val',v=>v==0?'∞':v)" aria-label="上下文轮数">
                <span class="slider-val" id="chat-memory-val">10</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-temp">Temperature <span class="field-hint">（随机性，越高越发散）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-temp" type="range" min="0" max="2" step="0.001" value="1" oninput="syncParam(this,'temp-val',v=>parseFloat(v).toFixed(3))" aria-label="温度参数">
                <span class="slider-val" id="temp-val">1.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-top-p">Top P <span class="field-hint">（核采样，过滤低概率词）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-top-p" type="range" min="0" max="1" step="0.001" value="1" oninput="syncParam(this,'top-p-val',v=>parseFloat(v).toFixed(3))" aria-label="Top P 参数">
                <span class="slider-val" id="top-p-val">1.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-top-k">Top K <span class="field-hint">（候选词数量，0 = 不限）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-top-k" type="range" min="0" max="200" step="1" value="0" oninput="syncParam(this,'top-k-val',v=>parseInt(v))" aria-label="Top K 参数">
                <span class="slider-val" id="top-k-val">0</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-freq-pen">Frequency Penalty <span class="field-hint">（降低重复词频率）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-freq-pen" type="range" min="-2" max="2" step="0.001" value="0" oninput="syncParam(this,'freq-pen-val',v=>parseFloat(v).toFixed(3))" aria-label="频率惩罚">
                <span class="slider-val" id="freq-pen-val">0.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-pres-pen">Presence Penalty <span class="field-hint">（鼓励引入新话题）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-pres-pen" type="range" min="-2" max="2" step="0.001" value="0" oninput="syncParam(this,'pres-pen-val',v=>parseFloat(v).toFixed(3))" aria-label="存在惩罚">
                <span class="slider-val" id="pres-pen-val">0.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-rep-pen">Repetition Penalty <span class="field-hint">（惩罚重复内容，&gt;1 更严）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-rep-pen" type="range" min="0.5" max="2" step="0.001" value="1" oninput="syncParam(this,'rep-pen-val',v=>parseFloat(v).toFixed(3))" aria-label="重复惩罚">
                <span class="slider-val" id="rep-pen-val">1.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-min-p">Min P <span class="field-hint">（最低概率阈值过滤）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-min-p" type="range" min="0" max="1" step="0.001" value="0" oninput="syncParam(this,'min-p-val',v=>parseFloat(v).toFixed(3))" aria-label="Min P 参数">
                <span class="slider-val" id="min-p-val">0.000</span>
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="s-top-a">Top A <span class="field-hint">（自适应采样阈值）</span></label>
              <div class="slider-row">
                <input class="slider" id="s-top-a" type="range" min="0" max="1" step="0.001" value="0" oninput="syncParam(this,'top-a-val',v=>parseFloat(v).toFixed(3))" aria-label="Top A 参数">
                <span class="slider-val" id="top-a-val">0.000</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Options -->
          <div class="collapse-head" onclick="toggleCollapse('opts')">
            <div class="collapse-head-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              功能选项
            </div>
            <svg class="collapse-arrow open" id="arrow-opts" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </div>
          <div class="collapse-body" id="body-opts">
            <div class="toggle-row">
              <div class="toggle-info"><div class="toggle-name">流式传输</div><div class="toggle-desc">逐字实时输出</div></div>
              <div class="toggle on" id="stream-toggle" onclick="toggleOpt('stream')"></div>
            </div>
            <div class="toggle-row">
              <div class="toggle-info"><div class="toggle-name">Markdown 渲染</div><div class="toggle-desc">格式化 AI 回复</div></div>
              <div class="toggle on" id="md-toggle" onclick="toggleOpt('md')"></div>
            </div>
            <div class="toggle-row">
              <div class="toggle-info"><div class="toggle-name">代码高亮</div><div class="toggle-desc">语法着色</div></div>
              <div class="toggle on" id="hl-toggle" onclick="toggleOpt('hl')"></div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- System Prompt -->
          <div class="collapse-head" onclick="toggleCollapse('sys')">
            <div class="collapse-head-left">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
              系统提示词
            </div>
            <svg class="collapse-arrow open" id="arrow-sys" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </div>
          <div class="collapse-body" id="body-sys">
            <label for="system-prompt" class="sr-only">系统提示词</label>
            <textarea class="textarea" id="system-prompt" rows="5"
              placeholder="设定 AI 的角色或行为规则…" oninput="saveSettings()" aria-label="系统提示词">You are a helpful, accurate, and thoughtful AI assistant.</textarea>
          </div>

          <div class="divider"></div>

          <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">消息数</div><div class="stat-val" id="msg-count">0</div></div>
            <div class="stat-box"><div class="stat-label">总字符</div><div class="stat-val" id="char-total">0</div></div>
          </div>
        </div>
      </div>

      <!-- History Panel -->
      <div id="panel-history">
        <div class="panel-header">
          <span class="panel-title">对话列表</span>
          <button class="new-chat-btn-inline" onclick="newChat()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            新建
          </button>
          <button class="panel-close" onclick="switchPanel(null)" aria-label="关闭面板">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="conv-list" id="conv-list">
          <div class="conv-empty">暂无历史对话</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Chat -->
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="empty-state" id="empty-state">
        <div class="empty-icon">✦</div>
        <div class="empty-title">开始对话</div>
        <div class="empty-sub">在下方输入你的问题</div>
      </div>
    </div>
    <div class="input-bar-outer">
      <div class="input-bar">
        <div class="input-wrap">
          <textarea id="user-input" rows="1" placeholder="输入消息，Ctrl+Enter 发送…" oninput="autoResize(this);updateCharCount()" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="send-btn" onclick="handleSendBtn()" title="发送 (Ctrl+Enter)">
            <svg id="send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
            <svg id="stop-icon" viewBox="0 0 24 24" fill="currentColor">
              <rect x="4" y="4" width="16" height="16" rx="2"/>
            </svg>
          </button>
        </div>
        <div class="input-footer">
          <div class="key-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> 发送 &nbsp;·&nbsp; <kbd>Enter</kbd> 换行</div>
          <span class="char-count" id="char-count">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ══ STATE ══
let currentConvId = null;
let currentMessages = [];
let isGenerating = false;
let abortCtrl = null;
let streamEnabled = true;
let mdEnabled = true;
let hlEnabled = true;
let activePanel = 'settings';

// ══ API PRESETS ══
let apiPresets = [];
let activePresetId = null;
let fullApiKeys = {}; // { presetId: plaintext key }

function getDefaultPresets() {
  return [{ id: 'preset_default', name: 'openrouter', url: 'https://openrouter.ai/api/v1/chat/completions', model: 'deepseek/deepseek-chat-v3.1', format: 'openai' }];
}

function getActivePreset() {
  return apiPresets.find(p => p.id === activePresetId) || apiPresets[0];
}

function renderPresetDropdown() {
  const dd = g('preset-dropdown');
  dd.innerHTML = apiPresets.map(p => `<div class="preset-item${p.id===activePresetId?' active':''}" onclick="selectPreset('${p.id}')">
      <span class="preset-item-name" id="pname-${p.id}">${escapeHtml(p.name)}</span>
      <div class="preset-item-actions">
        <button class="preset-action-btn" onclick="startRenamePreset(event,'${p.id}')" title="重命名" type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button class="preset-action-btn del" onclick="deletePreset(event,'${p.id}')" title="删除" type="button"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
    </div>`).join('') +
    `<div class="preset-divider"></div><div class="preset-new-btn" onclick="addNewPreset()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>新建预设</div>`;
}

function togglePresetDropdown() {
  const dd = g('preset-dropdown'), btn = g('preset-btn');
  const isOpen = !dd.classList.contains('hidden');
  if (isOpen) { dd.classList.add('hidden'); btn.classList.remove('open'); }
  else { renderPresetDropdown(); dd.classList.remove('hidden'); btn.classList.add('open'); }
}

function selectPreset(id) {
  activePresetId = id;
  const p = getActivePreset();
  g('preset-btn-name').textContent = p.name;
  g('preset-dropdown').classList.add('hidden');
  g('preset-btn').classList.remove('open');
  g('api-url').value = p.url;
  g('model-name').value = p.model;
  g('model-badge').textContent = p.model;
  g('api-format').value = p.format;
  const plainKey = fullApiKeys[id] || '';
  fullApiKey = plainKey;
  isTypingApiKey = false;
  if (plainKey && plainKey.length > 12) {
    g('api-key').value = plainKey.substring(0,8) + '*'.repeat(plainKey.length-12) + plainKey.substring(plainKey.length-4);
  } else { g('api-key').value = plainKey; }
  saveSettings();
}

function onPresetFieldChange() {
  const p = getActivePreset();
  if (!p) return;
  p.url = g('api-url').value;
  p.model = g('model-name').value;
  p.format = g('api-format').value;
  saveSettings();
}

async function addNewPreset() {
  const id = 'preset_' + Date.now();
  apiPresets.push({ id, name: '新预设', url: '', model: '', format: 'openai' });
  fullApiKeys[id] = '';
  selectPreset(id);
  renderPresetDropdown();
  setTimeout(() => startRenamePreset(null, id), 50);
}

function startRenamePreset(e, id) {
  e && e.stopPropagation();
  const nameEl = g('pname-' + id);
  if (!nameEl) return;
  const oldName = apiPresets.find(p => p.id === id)?.name || '';
  const input = document.createElement('input');
  input.className = 'preset-item-name-input';
  input.value = oldName;
  nameEl.replaceWith(input);
  input.focus(); input.select();
  let saved = false;
  const finish = () => {
    if (saved) return; saved = true;
    const newName = input.value.trim() || oldName;
    const p = apiPresets.find(p => p.id === id);
    if (p) p.name = newName;
    if (id === activePresetId) g('preset-btn-name').textContent = newName;
    renderPresetDropdown();
    saveSettings();
  };
  input.addEventListener('keydown', ev => { if(ev.key==='Enter'){ev.preventDefault();finish();} if(ev.key==='Escape'){saved=true;renderPresetDropdown();} });
  input.addEventListener('blur', finish);
}

async function deletePreset(e, id) {
  e && e.stopPropagation();
  if (apiPresets.length <= 1) { showToast('至少保留一个预设'); return; }
  apiPresets = apiPresets.filter(p => p.id !== id);
  delete fullApiKeys[id];
  if (activePresetId === id) selectPreset(apiPresets[0].id);
  else { renderPresetDropdown(); saveSettings(); }
}

// ══ MARKED ══
marked.setOptions({ breaks: true, gfm: true });
const mdRenderer = new marked.Renderer();
mdRenderer.code = function(code, lang) {
  const language = lang || 'plaintext';
  let hl = escapeHtml(code);
  if (hlEnabled) {
    try {
      hl = hljs.getLanguage(language)
        ? hljs.highlight(code, { language }).value
        : hljs.highlightAuto(code).value;
    } catch(e) {}
  }
  return `<div class="code-block-wrap"><div class="code-header"><span>${language}</span><span class="copy-btn" onclick="copyCode(this)">复制</span></div><pre><code class="hljs">${hl}</code></pre></div>`;
};
marked.use({ renderer: mdRenderer });

function renderMd(text) {
  if (!mdEnabled) return `<span class="plain-text">${escapeHtml(text)}</span>`;
  return marked.parse(text);
}
function escapeHtml(t) {
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ══ ENCRYPTION ══
// 使用 Electron safeStorage（系统级加密）或降级到简单加密
async function encryptText(text) {
  if (!text) return '';

  // 在 Electron 环境中使用系统级加密
  if (isElectron && window.electronAPI.encryptData) {
    const result = await window.electronAPI.encryptData(text);
    if (result.success) {
      return result.data;
    }
  }

  // 降级到简单 XOR 加密（仅用于开发环境）
  const key = 'AI-CHAT-SECRET-KEY-2024';
  let result = '';
  for (let i = 0; i < text.length; i++) {
    result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
  }
  return btoa(result);
}

async function decryptText(encrypted) {
  if (!encrypted) return '';

  // 在 Electron 环境中使用系统级解密
  if (isElectron && window.electronAPI.decryptData) {
    const result = await window.electronAPI.decryptData(encrypted);
    if (result.success) {
      return result.data;
    }
  }

  // 降级到简单 XOR 解密（仅用于开发环境）
  try {
    const decoded = atob(encrypted);
    const key = 'AI-CHAT-SECRET-KEY-2024';
    let result = '';
    for (let i = 0; i < decoded.length; i++) {
      result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return result;
  } catch(e) {
    return encrypted;
  }
}

// ══ FILE STORAGE ══
const FILES = { S:'settings.json', C:'conversations.json', A:'active.json' };

// 检查是否在 Electron 环境中
const isElectron = typeof window.electronAPI !== 'undefined';

// 读取数据（优先使用文件存储，降级到 localStorage）
async function getData(key) {
  if (isElectron) {
    const filename = FILES[key];
    const result = await window.electronAPI.readData(filename);
    if (result.success) {
      try {
        return JSON.parse(result.data);
      } catch(e) {
        return null;
      }
    }
    return null;
  } else {
    // 降级到 localStorage（开发环境或浏览器中）
    try {
      return JSON.parse(localStorage.getItem('dschat_' + key.toLowerCase()));
    } catch(e) {
      return null;
    }
  }
}

// 写入数据（优先使用文件存储，降级到 localStorage）
async function setData(key, value) {
  if (isElectron) {
    const filename = FILES[key];
    const data = JSON.stringify(value, null, 2);
    await window.electronAPI.writeData(filename, data);
  } else {
    // 降级到 localStorage（开发环境或浏览器中）
    try {
      localStorage.setItem('dschat_' + key.toLowerCase(), JSON.stringify(value));
    } catch(e) {}
  }
}

// ══ API KEY MASKING ══
let fullApiKey = ''; // 存储完整的 API Key
let isTypingApiKey = false; // 标记是否正在输入

function maskApiKey() {
  const input = g('api-key');
  if (!input) return;

  const value = input.value;

  // 如果是遮罩格式（包含星号），不处理
  if (value.includes('*')) return;

  // 如果有完整值，保存并遮罩
  if (value && value.length > 12) {
    fullApiKey = value;
    const first8 = value.substring(0, 8);
    const last4 = value.substring(value.length - 4);
    input.value = `${first8}${'*'.repeat(value.length - 12)}${last4}`;
  } else if (value) {
    fullApiKey = value;
  }
}

function handleApiKeyInput(event) {
  const input = g('api-key');
  if (!input) return;
  const value = input.value;
  if (!isTypingApiKey && value.includes('*')) {
    input.value = '';
    fullApiKey = '';
    fullApiKeys[activePresetId] = '';
    isTypingApiKey = true;
    return;
  }
  isTypingApiKey = true;
  fullApiKey = value;
  clearTimeout(input.saveTimer);
  input.saveTimer = setTimeout(() => {
    maskApiKey();
    fullApiKeys[activePresetId] = fullApiKey;
    saveSettings();
    isTypingApiKey = false;
  }, 1000);
}

async function saveSettings() {
  const encryptedPresets = await Promise.all(apiPresets.map(async p => ({
    ...p,
    key: await encryptText(fullApiKeys[p.id] || '')
  })));
  await setData('S', {
    presets: encryptedPresets,
    activePresetId,
    maxTokens: g('s-max-tokens').value, chatMemory: g('s-chat-memory').value,
    temp: g('s-temp').value,
    topP: g('s-top-p').value, topK: g('s-top-k').value,
    freqPen: g('s-freq-pen').value, presPen: g('s-pres-pen').value,
    repPen: g('s-rep-pen').value, minP: g('s-min-p').value, topA: g('s-top-a').value,
    sysPrompt: g('system-prompt').value,
    stream: streamEnabled, md: mdEnabled, hl: hlEnabled,
    activePanel,
    collapseStates: getCollapseStates(),
  });
}

async function loadSettings() {
  const s = await getData('S');
  const setv = (id, val) => { if(g(id)) g(id).value = val; };

  // 加载预设
  if (s?.presets?.length) {
    for (const p of s.presets) {
      fullApiKeys[p.id] = p.key ? await decryptText(p.key) : '';
    }
    apiPresets = s.presets.map(p => { const {key, ...rest} = p; return rest; });
    activePresetId = s.activePresetId || apiPresets[0].id;
  } else if (s?.apiUrl) {
    const id = 'preset_migrated';
    apiPresets = [{ id, name: s.apiProvider || 'openrouter', url: s.apiUrl, model: s.modelName || 'deepseek/deepseek-chat-v3.1', format: 'openai' }];
    fullApiKeys[id] = s.apiKey ? await decryptText(s.apiKey) : '';
    activePresetId = id;
  } else {
    apiPresets = getDefaultPresets();
    activePresetId = apiPresets[0].id;
    fullApiKeys[activePresetId] = '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';
  }

  // 填充当前预设字段
  const p = getActivePreset();
  g('preset-btn-name').textContent = p.name;
  g('api-url').value = p.url;
  g('model-name').value = p.model;
  g('model-badge').textContent = p.model;
  g('api-format').value = p.format || 'openai';
  const plainKey = fullApiKeys[activePresetId] || '';
  fullApiKey = plainKey;
  if (plainKey && plainKey.length > 12) {
    g('api-key').value = plainKey.substring(0,8) + '*'.repeat(plainKey.length-12) + plainKey.substring(plainKey.length-4);
  } else { g('api-key').value = plainKey; }

  if (!s) return;
  setv('s-max-tokens',  s.maxTokens   ?? 0);
  setv('s-chat-memory', s.chatMemory  ?? 10);
  setv('s-temp',        s.temp        ?? 1);
  setv('s-top-p',       s.topP        ?? 1);
  setv('s-top-k',       s.topK        ?? 0);
  setv('s-freq-pen',    s.freqPen     ?? 0);
  setv('s-pres-pen',    s.presPen     ?? 0);
  setv('s-rep-pen',     s.repPen      ?? 1);
  setv('s-min-p',       s.minP        ?? 0);
  setv('s-top-a',       s.topA        ?? 0);
  setv('system-prompt', s.sysPrompt   ?? 'You are a helpful, accurate, and thoughtful AI assistant.');
  streamEnabled = s.stream !== false;
  mdEnabled     = s.md     !== false;
  hlEnabled     = s.hl     !== false;
  g('stream-toggle').classList.toggle('on', streamEnabled);
  g('md-toggle').classList.toggle('on', mdEnabled);
  g('hl-toggle').classList.toggle('on', hlEnabled);
  refreshDisplays();
  if (s.collapseStates) applyCollapseStates(s.collapseStates);
  if ('activePanel' in s) restorePanel(s.activePanel);
}

function refreshDisplays() {
  const mt = parseInt(g('s-max-tokens').value);
  g('max-tokens-val').textContent  = mt === 0 ? '∞' : mt;
  const cm = parseInt(g('s-chat-memory').value);
  g('chat-memory-val').textContent = cm === 0 ? '∞' : cm;
  g('temp-val').textContent        = parseFloat(g('s-temp').value).toFixed(3);
  g('top-p-val').textContent       = parseFloat(g('s-top-p').value).toFixed(3);
  g('top-k-val').textContent       = parseInt(g('s-top-k').value);
  g('freq-pen-val').textContent    = parseFloat(g('s-freq-pen').value).toFixed(3);
  g('pres-pen-val').textContent    = parseFloat(g('s-pres-pen').value).toFixed(3);
  g('rep-pen-val').textContent     = parseFloat(g('s-rep-pen').value).toFixed(3);
  g('min-p-val').textContent       = parseFloat(g('s-min-p').value).toFixed(3);
  g('top-a-val').textContent       = parseFloat(g('s-top-a').value).toFixed(3);
}

function syncParam(el, valId, fmt) {
  g(valId).textContent = fmt(el.value);
  saveSettings();
}

// ══ CONVERSATIONS ══
async function getConvs() { return await getData('C') || []; }
async function setConvs(v) { await setData('C', v); }

async function saveCurrentConv() {
  if (!currentConvId) return;
  const convs = await getConvs();
  const idx = convs.findIndex(c => c.id === currentConvId);
  if (idx < 0) return;
  convs[idx].messages = currentMessages;
  convs[idx].updatedAt = Date.now();
  const firstUser = currentMessages.find(m => m.role === 'user');
  if (firstUser) convs[idx].title = firstUser.content.slice(0, 28) + (firstUser.content.length > 28 ? '…' : '');
  await setConvs(convs);
  renderConvList();
}

async function newChat(saveCurrent = true) {
  if (saveCurrent) await saveCurrentConv();
  const id = 'c' + Date.now();
  const convs = await getConvs();
  convs.unshift({ id, title: '新对话', messages: [], createdAt: Date.now(), updatedAt: Date.now() });
  await setConvs(convs);
  currentConvId = id;
  currentMessages = [];
  await setData('A', id);
  renderMessages();
  renderConvList();
  updateStats();
}

async function loadConv(id) {
  await saveCurrentConv();
  const convs = await getConvs();
  const conv = convs.find(c => c.id === id);
  if (!conv) return;
  currentConvId = id;
  currentMessages = conv.messages || [];
  await setData('A', id);
  renderMessages();
  renderConvList();
  updateStats();
  scrollToBottom();
}

async function deleteConv(id, e) {
  e && e.stopPropagation();
  const convs = await getConvs();
  let filtered = convs.filter(c => c.id !== id);
  await setConvs(filtered);
  if (currentConvId === id) {
    if (filtered.length > 0) await loadConv(filtered[0].id);
    else await newChat(false);
  } else renderConvList();
  showToast('已删除');
}

async function renderConvList() {
  const list = g('conv-list');
  const convs = await getConvs();
  if (!convs.length) { list.innerHTML = '<div class="conv-empty">暂无历史对话</div>'; return; }
  list.innerHTML = convs.map(c => {
    const d = new Date(c.updatedAt);
    const meta = d.toLocaleDateString('zh-CN',{month:'numeric',day:'numeric'}) + ' ' + d.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit'});
    return `<div class="conv-item${c.id===currentConvId?' active':''}" onclick="loadConv('${c.id}')">
      <div class="conv-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
      <div class="conv-info">
        <div class="conv-title">${escapeHtml(c.title)}</div>
        <div class="conv-meta">${c.messages.filter(m=>m.role!=='system').length} 条 · ${meta}</div>
      </div>
      <button class="conv-del" onclick="deleteConv('${c.id}',event)" title="删除">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`;
  }).join('');
}

// ══ RENDER MESSAGES ══
function renderMessages() {
  const container = g('messages');
  if (!currentMessages.filter(m=>m.role!=='system').length) {
    container.innerHTML = `<div class="empty-state" id="empty-state"><div class="empty-icon">✦</div><div class="empty-title">开始对话</div><div class="empty-sub">在下方输入你的问题</div></div>`;
    return;
  }
  container.innerHTML = '';
  currentMessages.forEach(m => { if(m.role!=='system') appendBubble(m.role, m.content); });
}

// ══ SEND / STOP ══
function handleSendBtn() {
  if (isGenerating) { if(abortCtrl) abortCtrl.abort(); }
  else sendMessage();
}

async function sendMessage() {
  if (isGenerating) return;
  const input = g('user-input');
  const text = input.value.trim();
  if (!text) return;

  // 验证 API Key 格式
  const apiKeyCheck = fullApiKey || g('api-key').value;
  if (apiKeyCheck && !/^[\x00-\x7F]*$/.test(apiKeyCheck)) {
    alert('⚠ API Key 包含非法字符，请检查是否包含中文或特殊符号');
    return;
  }

  if (!currentConvId) newChat(false);

  const es = g('empty-state');
  if (es) es.remove();

  appendBubble('user', text);
  currentMessages.push({ role: 'user', content: text });
  input.value = ''; autoResize(input); updateCharCount(); updateStats();

  const aiRow = appendBubble('assistant', '', true);
  const contentEl = aiRow.querySelector('.bubble-content');
  setGenerating(true);

  // Read params
  const preset = getActivePreset();
  const apiUrl  = preset.url.trim();
  const apiKey  = (fullApiKey || '').trim();
  const model   = preset.model.trim();
  const format  = preset.format || 'openai';
  const sysP    = g('system-prompt').value.trim();
  const chatMemory = parseInt(g('s-chat-memory').value) || 0;
  const mt      = parseInt(g('s-max-tokens').value);
  const temp    = parseFloat(g('s-temp').value);
  const topP    = parseFloat(g('s-top-p').value);
  const topK    = parseInt(g('s-top-k').value);
  const freqPen = parseFloat(g('s-freq-pen').value);
  const presPen = parseFloat(g('s-pres-pen').value);
  const repPen  = parseFloat(g('s-rep-pen').value);
  const minP    = parseFloat(g('s-min-p').value);
  const topA    = parseFloat(g('s-top-a').value);

  abortCtrl = new AbortController();
  let fullText = '';

  try {
    setStatus('yellow','生成中…');

    // Prepare request based on API format
    let headers, body;

    // Apply chat memory limit (slice to last N rounds = 2N messages)
    const nonSysMsgs = currentMessages.filter(m => m.role !== 'system');
    const sliced = chatMemory > 0 ? nonSysMsgs.slice(-(chatMemory * 2)) : nonSysMsgs;

    if (format === 'claude') {
      // Claude API format
      headers = {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      };
      body = {
        model,
        max_tokens: mt > 0 ? mt : 4096,
        temperature: temp,
        top_p: topP,
        top_k: topK > 0 ? topK : undefined,
        stream: streamEnabled,
        messages: sliced.map(m => ({ role: m.role, content: m.content }))
      };
      if (sysP) body.system = sysP;
    } else {
      // OpenAI-compatible format
      headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      };
      const messages = [];
      if (sysP) messages.push({ role:'system', content:sysP });
      messages.push(...sliced);

      body = { model, messages, temperature: temp, top_p: topP, frequency_penalty: freqPen, presence_penalty: presPen, repetition_penalty: repPen, stream: streamEnabled };
      if (mt > 0)   body.max_tokens = mt;
      if (topK > 0) body.top_k = topK;
      if (minP > 0) body.min_p = minP;
      if (topA > 0) body.top_a = topA;
    }

    const res = await fetch(apiUrl, {
      method:'POST',
      headers,
      body: JSON.stringify(body),
      signal: abortCtrl.signal,
    });
    if (!res.ok) { const err = await res.text(); throw new Error(`HTTP ${res.status}: ${err}`); }

    if (streamEnabled) {
      const reader = res.body.getReader();
      const dec = new TextDecoder();
      let buf = '';

      if (format === 'claude') {
        while(true) {
          const {done, value} = await reader.read();
          if(done) break;
          buf += dec.decode(value, {stream:true});
          const lines = buf.split('\n');
          buf = lines.pop();
          for(const line of lines) {
            const t = line.trim();
            if(!t.startsWith('data: ')) continue;
            const d = t.slice(6);
            try {
              const chunk = JSON.parse(d);
              if (chunk.type === 'content_block_delta' && chunk.delta?.text) {
                fullText += chunk.delta.text;
                contentEl.innerHTML = renderMd(fullText) + '<span class="typing-cursor"></span>';
                scrollToBottom();
              }
            } catch(e){}
          }
        }
      } else {
        // OpenAI streaming format
        while(true) {
          const {done, value} = await reader.read();
          if(done) break;
          buf += dec.decode(value, {stream:true});
          const lines = buf.split('\n');
          buf = lines.pop();
          for(const line of lines) {
            const t = line.trim();
            if(!t.startsWith('data: ')) continue;
            const d = t.slice(6);
            if(d==='[DONE]') break;
            try {
              const chunk = JSON.parse(d);
              const delta = chunk.choices?.[0]?.delta?.content||'';
              if(delta){ fullText+=delta; contentEl.innerHTML=renderMd(fullText)+'<span class="typing-cursor"></span>'; scrollToBottom(); }
            } catch(e){}
          }
        }
      }
      contentEl.innerHTML = renderMd(fullText);
    } else {
      const data = await res.json();
      if (format === 'claude') {
        fullText = data.content[0].text;
      } else {
        fullText = data.choices[0].message.content;
      }
      contentEl.innerHTML = renderMd(fullText);
    }

    currentMessages.push({ role:'assistant', content:fullText });
    saveCurrentConv(); updateStats(); setStatus('green','就绪');

  } catch(err) {
    if(err.name==='AbortError') {
      if(fullText) {
        contentEl.innerHTML = renderMd(fullText) + '<span class="stop-marker">[ 已停止 ]</span>';
        currentMessages.push({ role:'assistant', content:fullText });
        saveCurrentConv(); updateStats();
      } else { aiRow.remove(); }
      setStatus('green','就绪');
    } else {
      contentEl.innerHTML = `<div class="error-bubble">⚠ ${escapeHtml(err.message)}</div>`;
      setStatus('red','出错'); setTimeout(()=>setStatus('green','就绪'),4000);
    }
  }
  setGenerating(false); scrollToBottom();
}

// ══ DOM HELPERS ══
function g(id){ return document.getElementById(id); }

function appendBubble(role, text, empty=false) {
  const isUser = role==='user';
  const row = document.createElement('div');
  row.className = 'message-row' + (isUser ? ' user-row' : '');
  row.innerHTML = `<div class="avatar ${role}">${isUser?'U':'AI'}</div>
    <div class="bubble">
      <div class="bubble-name ${isUser?'user-name':'ai-name'}">${isUser?'你':'DeepSeek'}</div>
      <div class="bubble-content ${isUser?'user-msg':'ai-msg'}">${empty?'<span class="typing-cursor"></span>':(isUser?escapeHtml(text):renderMd(text))}</div>
    </div>`;
  g('messages').appendChild(row);
  scrollToBottom();
  return row;
}

function scrollToBottom(){ const m=g('messages'); m.scrollTop=m.scrollHeight; }

function setGenerating(on) {
  isGenerating = on;
  const btn=g('send-btn');
  btn.classList.toggle('stop-mode',on);
  g('send-icon').style.display = on?'none':'';
  g('stop-icon').style.display = on?'':'none';
  btn.title = on?'停止生成':'发送 (Ctrl+Enter)';
}

function setStatus(s,t) {
  g('status-dot').className='status-dot '+s;
  g('status-text').textContent=t||s;
}

function clearCurrentChat() {
  if(isGenerating) return showToast('请先停止生成');
  currentMessages = [];
  saveCurrentConv();
  renderMessages();
  updateStats();
  showToast('对话已清空');
}

function updateStats() {
  const msgs = currentMessages.filter(m=>m.role!=='system');
  g('msg-count').textContent = msgs.length;
  const total = currentMessages.reduce((a,m)=>a+m.content.length,0);
  g('char-total').textContent = total>9999?(total/1000).toFixed(1)+'k':total;
}

function updateCharCount(){ g('char-count').textContent=g('user-input').value.length; }
function autoResize(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,180)+'px'; }
function handleKey(e){ if(e.key==='Enter'&&e.ctrlKey){ e.preventDefault(); sendMessage(); } }

function copyCode(btn) {
  navigator.clipboard.writeText(btn.closest('.code-block-wrap').querySelector('code').innerText)
    .then(()=>{ btn.textContent='已复制'; setTimeout(()=>btn.textContent='复制',1500); });
}

function showToast(msg) {
  const t=g('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}

// ══ PANEL / COLLAPSE ══
function switchPanel(name) {
  const panel=g('sidebar-panel');
  const sp=g('panel-settings'), hp=g('panel-history');
  const rs=g('rail-settings'), rh=g('rail-history');
  if(name===activePanel||!name) {
    activePanel=null; panel.classList.add('hidden');
    rs.classList.remove('active'); rh.classList.remove('active');
    saveSettings();
    return;
  }
  activePanel=name; panel.classList.remove('hidden');
  sp.style.display = name==='settings'?'flex':'none';
  hp.style.display  = name==='history' ?'flex':'none';
  rs.classList.toggle('active',name==='settings');
  rh.classList.toggle('active',name==='history');
  saveSettings();
}

// 仅用于 loadSettings 恢复布局，不触发 saveSettings
function restorePanel(name) {
  const panel=g('sidebar-panel');
  const sp=g('panel-settings'), hp=g('panel-history');
  const rs=g('rail-settings'), rh=g('rail-history');
  if (!name) {
    activePanel=null; panel.classList.add('hidden');
    rs.classList.remove('active'); rh.classList.remove('active');
    return;
  }
  activePanel=name; panel.classList.remove('hidden');
  sp.style.display = name==='settings'?'flex':'none';
  hp.style.display  = name==='history' ?'flex':'none';
  rs.classList.toggle('active',name==='settings');
  rh.classList.toggle('active',name==='history');
}

function toggleCollapse(key) {
  const body=g('body-'+key), arrow=g('arrow-'+key);
  const closing=!body.classList.contains('closed');
  body.classList.toggle('closed',closing);
  arrow.classList.toggle('open',!closing);
  saveSettings();
}

function getCollapseStates() {
  const keys = ['api','gen','opts','sys'];
  const states = {};
  keys.forEach(k => { states[k] = !g('body-'+k).classList.contains('closed'); });
  return states;
}

function applyCollapseStates(states) {
  Object.entries(states).forEach(([k, open]) => {
    const body = g('body-'+k), arrow = g('arrow-'+k);
    if (!body) return;
    body.classList.toggle('closed', !open);
    arrow.classList.toggle('open', open);
  });
}

function toggleOpt(key) {
  if(key==='stream'){ streamEnabled=!streamEnabled; g('stream-toggle').classList.toggle('on',streamEnabled); }
  if(key==='md'){     mdEnabled=!mdEnabled;         g('md-toggle').classList.toggle('on',mdEnabled); }
  if(key==='hl'){     hlEnabled=!hlEnabled;         g('hl-toggle').classList.toggle('on',hlEnabled); }
  saveSettings();
}

// ══ INIT ══
(async function init(){
  await loadSettings();
  const convs = await getConvs();
  const savedId = await getData('A');
  if(convs.length>0){
    const target = savedId ? convs.find(c=>c.id===savedId) : convs[0];
    if(target){ currentConvId=target.id; currentMessages=target.messages||[]; }
    else await newChat(false);
  } else { await newChat(false); }
  renderMessages(); renderConvList(); updateStats(); scrollToBottom();
  document.addEventListener('click', e => {
    const sel = g('preset-selector');
    if (sel && !sel.contains(e.target)) {
      g('preset-dropdown').classList.add('hidden');
      g('preset-btn').classList.remove('open');
    }
  });
})();
</script>
</body>
</html>
